SEL *
FROM (
		SEL
		{IBM_STG_TABLE_COLUMNS}
		FROM GPROD1V_{LOADING_TYPE}.{TABLE_NAME} IBM_STG_TABLE
				JOIN STG_ONLINE.IBM_AUDIT_TABLE IBM_AUDIT_TABLE
		ON  IBM_STG_TABLE.BATCH_ID = IBM_AUDIT_TABLE.MIC_RUNID
		AND IBM_STG_TABLE.LOAD_ID = IBM_AUDIT_TABLE.MIC_EXECUTIONGUID
		WHERE IBM_STG_TABLE.REF_KEY NOT IN 
			(
				SEL DISTINCT REF_KEY FROM {source_DB}.{REJ_TABLE_NAME} RJT
				INNER JOIN {source_DB}.{REJ_TABLE_RULE} BRT
				ON RJT.RULE_ID = BRT.RULE_ID
				AND ACTIVE =1 
			)
		AND DB2_TO_TERA_STATUS LIKE '%SUCCESS%'
		AND DB2_JOB_END_TIME IS NOT NULL
		QUALIFY ROW_NUMBER() OVER (PARTITION BY {TBL_PKs} ORDER BY BATCH_ID DESC,DATA_EXTRACTION_DATE DESC,MODIFICATION_TYPE DESC,REF_KEY DESC)=1
UNION ALL
		(
			SEL
			{TERADATA_STG_TABLE_COLUMNS}
			FROM {STG_DATABASE}.{TABLE_NAME} TERADATA_STG_TABLE
		UNION ALL
			SEL
			{TERADATA_WRK_TABLE_COLUMNS}
			FROM {WRK_DATABASE}.{TABLE_NAME} TERADATA_WRK_TABLE
		)
	)TST
GROUP BY {COUNT_COLS}
HAVING COUNT(*) = 1;